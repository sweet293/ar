<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }

      /* --- Overlay UI styles --- */
      #ui {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 9999;
        display: none;
        flex-direction: column;
        gap: 10px;
      }

      .btn {
        background: rgba(0, 0, 0, 0.7);
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-size: 18px;
        width: fit-content;
      }

      .btn:active {
        background: rgba(0, 0, 0, 0.9);
      }
    </style>
  </head>

  <body>

    <!-- UI Overlay -->
    <div id="ui">
      <div id="nextClueBtn" class="btn">Next clue</div>
      <div id="clueText" class="btn" style="display:none;">
        superhero team from Marvel Comics
      </div>
    </div>

    <a-scene
      embedded
      renderer="logarithmicDepthBuffer: true;"
      vr-mode-ui="enabled: false"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: true;"
      emitevents="true"
    >
      <a-nft id="marker1" type="nft" url="assets/markers/1">

        <!-- Bomb -->
        <a-entity id="bomb"
                  gltf-model="assets/models/stylized_bomb/scene.gltf"
                  position="0 100 0"
                  rotation="-90 0 0"
                  scale="50 50 50"
                  visible="true">
        </a-entity>

        <!-- Explosion -->
        <a-entity id="explosion"
                  gltf-model="assets/models/explosion_as_solid/scene.gltf"
                  position="0 100 0"
                  rotation="-90 0 0"
                  scale="20 20 20"
                  visible="false">
        </a-entity>

        <!-- Light -->
        <a-entity light="type: ambient; intensity: 2"></a-entity>

      </a-nft>

      <!-- ******* NEW MARKER 2628 ******* -->
      <a-nft id="marker2628" type="nft" url="assets/markers/2628">

        <a-entity id="ironMan"
                  gltf-model="assets/models/iron_man_rig/scene.gltf"
                  position="0 0 0"
                  rotation="-90 0 0"
                  scale="0.5 0.5 0.5"
                  visible="false"
                  debug-bounds>       
        </a-entity>

        <a-entity id="hammer"
                  gltf-model="assets/models/hammer/scene.gltf"
                  position="0 100 0"
                  rotation="-90 0 0"
                  scale="20 20 20"
                  visible="false">
        </a-entity>

        <a-entity light="type: ambient; intensity: 2"></a-entity>
      </a-nft>
      <!-- **************************************** -->

      <!-- ******* MARKER MENU ******* -->
      <a-nft id="markerMenu" type="nft" url="assets/markers/menu">

        <a-entity id="croissant"
                  gltf-model="assets/models/croissant/scene.gltf"
                  position="0 50 0"
                  rotation="-90 0 0"
                  scale="5 5 5"
                  visible="false">       
        </a-entity>

        <a-entity light="type: ambient; intensity: 2"></a-entity>
      </a-nft>
      <!-- **************************************** -->

      <a-entity camera id="camera"></a-entity>
    </a-scene>


    <script>
      AFRAME.registerComponent('debug-bounds', {
        init: function () {
          this.el.addEventListener('model-loaded', (e) => {
            const model = e.detail.model;
            model.position.set(0, 0, 0);
            model.scale.set(1, 1, 1);
            model.rotation.set(0, 0, 0);
            const box = new THREE.Box3().setFromObject(model);
            console.log("IronMan bounding box:", box);
            this.el.setAttribute('visible', true);
          });
        }
      });
    </script>
      

    <script>
      document.addEventListener("DOMContentLoaded", () => {
      
        let currentStep = 1;
        let step2ClickCount = 0;
        let step3ClickCount = 0;
      
        const camera = document.querySelector("#camera");
      
        // MARKER 1
        const bomb = document.querySelector("#bomb");
        const explosion = document.querySelector("#explosion");
      
        // MARKER 2628
        const marker2628 = document.querySelector("#marker2628");
        const ironMan = document.querySelector("#ironMan");
      
        // MARKER MENU
        const markerMenu = document.querySelector("#markerMenu");
        const croissant = document.querySelector("#croissant");
      
        // UI
        const ui = document.querySelector("#ui");
        const nextClueBtn = document.querySelector("#nextClueBtn");
        const clueText = document.querySelector("#clueText");
      
        const raycaster = new THREE.Raycaster();
        const touchPoint = new THREE.Vector2();
      
      
        /* ----------------------------------------------------
         * STEP 1 ‚Äî TOUCH BOMB
         * ---------------------------------------------------- */
        window.addEventListener("touchstart", (e) => {
          console.log("Touch detected! currentStep:", currentStep);
          if (currentStep !== 1) {
            console.log("Not step 1, ignoring touch");
            return;
          }
      
          const touch = e.touches[0];
          touchPoint.x = (touch.clientX / window.innerWidth) * 2 - 1;
          touchPoint.y = -(touch.clientY / window.innerHeight) * 2 + 1;
      
          const cam = camera.getObject3D("camera");
          raycaster.setFromCamera(touchPoint, cam);
      
          const bombObj = bomb.getObject3D("mesh");
          console.log("Bomb object:", bombObj);
          if (bombObj) {
            const hitBomb = raycaster.intersectObject(bombObj, true);
            console.log("Hit bomb?", hitBomb.length > 0);
            if (hitBomb.length > 0) {
              console.log("üí£ Bomb touched!");
              bomb.setAttribute("visible", false);
              explosion.setAttribute("visible", true);
      
              ui.style.display = "flex";
              nextClueBtn.style.display = "block";
              nextClueBtn.innerText = "Next clue";
            }
          }
        });
      
      
        /* ----------------------------------------------------
         * NEXT CLUE BUTTON HANDLER
         * ---------------------------------------------------- */
        nextClueBtn.addEventListener("click", () => {
          console.log("Next clue clicked, currentStep:", currentStep, "step2ClickCount:", step2ClickCount, "step3ClickCount:", step3ClickCount);
          
          if (currentStep === 1) {
            // Step 1: Show first clue
            nextClueBtn.style.display = "none";
            clueText.innerText = "superhero team from Marvel Comics";
            clueText.style.display = "block";
            explosion.setAttribute("visible", false);
            console.log("Showing Marvel clue");
          } 
          else if (currentStep === 2 && step2ClickCount === 0) {
            // Step 2: First click - show second clue
            nextClueBtn.style.display = "none";
            clueText.innerText = "you eat or die";
            clueText.style.display = "block";
            step2ClickCount = 1;
            console.log("Showing emotions clue");
          }
        });
      
      
        /* ----------------------------------------------------
         * CLUE TEXT HANDLER
         * ---------------------------------------------------- */
        clueText.addEventListener("click", () => {
          console.log("Clue clicked, currentStep:", currentStep, "step2ClickCount:", step2ClickCount, "step3ClickCount:", step3ClickCount);
          
          if (currentStep === 1) {
            // Step 1: Move to step 2
            ui.style.display = "none";
            clueText.style.display = "none";
            nextClueBtn.style.display = "none";
            currentStep = 2;
            console.log("Moved to Step 2 - scan marker 2628 now");
          } 
          else if (currentStep === 2 && step2ClickCount === 1) {
            // Step 2: Move to step 3
            ui.style.display = "none";
            ironMan.setAttribute("visible", false);
            currentStep = 3;
            step2ClickCount = 0;
            console.log("Puzzle complete!");
            alert("Treasure hunt complete! üéâ");
          }
        });
      
      
        /* ----------------------------------------------------
         * STEP 2 ‚Äî SCAN MARKER 2628
         * ---------------------------------------------------- */
        console.log("marker2628 element:", marker2628);
        console.log("Does marker2628 exist?", marker2628 !== null);
        
        marker2628.addEventListener("markerFound", () => {
          console.log("üéØ MARKER 2628 FOUND! currentStep:", currentStep);
          if (currentStep !== 2) {
            console.log("‚ö†Ô∏è Ignoring - not on step 2, currentStep is:", currentStep);
            return;
          }
      
          console.log("‚úÖ Processing marker 2628...");
          ironMan.setAttribute("visible", true);
      
          // Show UI again
          ui.style.display = "flex";
      
          // Top text = "Correct movie guessed!"
          clueText.innerText = "Correct movie guessed!";
          clueText.style.display = "block";
      
          // Button visible
          nextClueBtn.style.display = "block";
          nextClueBtn.innerText = "Next clue";
          
          // Reset click counter
          step2ClickCount = 0;
          console.log("‚úÖ UI should now show 'Correct movie guessed!' and 'Next clue' button");
        });
        
        marker2628.addEventListener("markerLost", () => {
          console.log("‚ùå Marker 2628 lost");
        });
      
        /* ----------------------------------------------------
         * STEP 3 ‚Äî SCAN MENU MARKER
         * ---------------------------------------------------- */
        console.log("markerMenu element:", markerMenu);
        console.log("Does markerMenu exist?", markerMenu !== null);
        
        markerMenu.addEventListener("markerFound", () => {
          console.log("üéØ MENU MARKER FOUND! currentStep:", currentStep);
          if (currentStep !== 3) {
            console.log("‚ö†Ô∏è Ignoring - not on step 3, currentStep is:", currentStep);
            return;
          }
      
          console.log("‚úÖ Processing Menu marker...");
          croissant.setAttribute("visible", true);
      
          // Show UI again
          ui.style.display = "flex";
      
          // Top text = "Correct movie guessed!"
          clueText.innerText = "Correct movie guessed!";
          clueText.style.display = "block";
      
          // Button visible
          nextClueBtn.style.display = "block";
          nextClueBtn.innerText = "Next clue";
          
          // Reset click counter
          step3ClickCount = 0;
          console.log("‚úÖ UI should now show 'Correct movie guessed!' and 'Next clue' button");
        });
        
        markerMenu.addEventListener("markerLost", () => {
          console.log("‚ùå Menu marker lost");
        });
      
      });
    </script>

  </body>
</html>